@startuml
!define RECTANGLE class

skinparam classAttributeIconSize 0
skinparam backgroundColor #FFFFFF
skinparam roundcorner 5
skinparam shadowing false

skinparam class {
    BackgroundColor #F8F9FA
    BorderColor #6C757D
    FontColor #212529
}

' Entidades principales
RECTANGLE "users" as Users #E3F2FD {
    +id: serial [PK]
    +email: varchar(100) [UK]
    +password: varchar(255)
    +name: varchar(100)
    +role: varchar(20)
    +is_active: boolean
    +created_at: timestamp
    +updated_at: timestamp
    --
    [INDEX] idx_users_email
    [INDEX] idx_users_role
}

RECTANGLE "categories" as Categories #E8F5E8 {
    +id: serial [PK]
    +name: varchar(100) [UK]
    +description: text
    +parent_id: int [FK]
    +is_active: boolean
    +created_at: timestamp
    +updated_at: timestamp
    --
    [INDEX] idx_categories_parent_id
    [INDEX] idx_categories_is_active
}

RECTANGLE "locations" as Locations #FFF3E0 {
    +id: serial [PK]
    +name: varchar(100)
    +description: text
    +zone: varchar(50)
    +shelf: varchar(50)
    +is_active: boolean
    +created_at: timestamp
    +updated_at: timestamp
}

RECTANGLE "suppliers" as Suppliers #F3E5F5 {
    +id: serial [PK]
    +name: varchar(200)
    +contact_person: varchar(100)
    +email: varchar(100)
    +phone: varchar(20)
    +address: text
    +is_active: boolean
    +created_at: timestamp
    +updated_at: timestamp
}

RECTANGLE "products" as Products #FFEBEE {
    +id: serial [PK]
    +name: varchar(255)
    +description: text
    +sku: varchar(50) [UK]
    +price: numeric(10,2)
    +quantity: int
    +critical_stock: int
    +category_id: int [FK]
    +location_id: int [FK]
    +supplier_id: int [FK]
    +is_active: boolean
    +created_at: timestamp
    +updated_at: timestamp
    --
    [INDEX] idx_products_category_id
    [INDEX] idx_products_location_id
    [INDEX] idx_products_supplier_id
    [INDEX] idx_products_is_active
    [INDEX] idx_products_sku
    [INDEX] idx_products_name
}

RECTANGLE "product_movements" as Movements #FFF8E1 {
    +id: serial [PK]
    +product_id: int [FK]
    +movement_type: varchar(20)
    +quantity: int
    +previous_quantity: int
    +new_quantity: int
    +reason: varchar(200)
    +user_id: int [FK]
    +created_at: timestamp
    --
    [INDEX] idx_product_movements_product_id
    [INDEX] idx_product_movements_user_id
    [INDEX] idx_product_movements_created_at
}

RECTANGLE "audit_logs" as AuditLogs #F5F5F5 {
    +id: serial [PK]
    +table_name: varchar(50)
    +record_id: int
    +action: varchar(20)
    +old_values: jsonb
    +new_values: jsonb
    +user_id: int [FK]
    +ip_address: inet
    +user_agent: text
    +created_at: timestamp
    --
    [INDEX] idx_audit_logs_table_name
    [INDEX] idx_audit_logs_user_id
    [INDEX] idx_audit_logs_created_at
}

' Vistas del sistema
RECTANGLE "products_full_info" as ProductsView #E1F5FE {
    [VIEW]
    +id, name, description, sku
    +price, quantity, critical_stock
    +category_name, location_name
    +supplier_name, stock_status
    +created_at, updated_at
}

RECTANGLE "critical_stock_products" as CriticalStockView #FFCDD2 {
    [VIEW]
    +id, name, sku, quantity
    +critical_stock, category_name
    +location_name, supplier_name
}

RECTANGLE "recent_movements" as MovementsView #FFF9C4 {
    [VIEW]
    +id, product_name, sku
    +movement_type, quantity
    +previous_quantity, new_quantity
    +reason, user_name, created_at
}

' Relaciones principales
Products ||--o{ Movements : "1:N\n(Un producto tiene muchos movimientos)"
Movements }o--|| Users : "N:1\n(Muchos movimientos los realiza un usuario)"
Products }o--|| Categories : "N:1\n(Muchos productos pertenecen a una categoría)"
Products }o--|| Locations : "N:1\n(Muchos productos están en una ubicación)"
Products }o--|| Suppliers : "N:1\n(Muchos productos tienen un proveedor)"
AuditLogs }o--|| Users : "N:1\n(Muchos logs los genera un usuario)"

' Auto-relación para jerarquía de categorías
Categories }o--|| Categories : "N:1\n(Categorías pueden tener subcategorías)"

' Relaciones de auditoría
AuditLogs ..> Products : "Audita cambios"
AuditLogs ..> Categories : "Audita cambios"
AuditLogs ..> Locations : "Audita cambios"
AuditLogs ..> Suppliers : "Audita cambios"

' Vistas relacionadas
ProductsView ..> Products : "Consulta"
CriticalStockView ..> Products : "Filtra stock crítico"
MovementsView ..> Movements : "Consulta con joins"

' Triggers y funciones
note top of Products : "TRIGGER: audit_products_trigger\nTRIGGER: check_critical_stock_trigger\nTRIGGER: update_products_updated_at"
note top of Categories : "TRIGGER: audit_categories_trigger\nTRIGGER: update_categories_updated_at"
note top of Locations : "TRIGGER: audit_locations_trigger\nTRIGGER: update_locations_updated_at"
note top of Suppliers : "TRIGGER: audit_suppliers_trigger\nTRIGGER: update_suppliers_updated_at"
note top of Users : "TRIGGER: update_users_updated_at"

' Notas del sistema
note as N1
**Sistema de Inventario Industrial**
- PostgreSQL con triggers de auditoría
- Trazabilidad completa de movimientos
- Alertas de stock crítico
- Roles: ADMIN, USER, VIEWER
- Movimientos: IN, OUT, ADJUSTMENT
end note

note as N2
**Características Técnicas:**
- Índices optimizados para consultas
- Vistas para reportes comunes
- Auditoría automática con JSONB
- Validaciones de integridad
- Timestamps automáticos
end note

@enduml 